%%
clc;
clear all;
close all;
format long e;
% Dynamic Backward Euler problem 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
k=10;
k11=1.1;k12=k;k21=1.2;k22=k;k31=1.3;k32=k;k41=1.4;k42=k;
l1=2;l2=1;l3=0.8;l4=1.25;
m_1=1e-1;
m_2=2e-1;
m_3=3e-1;
m_4=4e-1;
m_5=5e-1;
m_6=6e-1;
m_7=7e-1;
m_8=8e-1;
m_9=9e-1;
m_10=10e-1;
m_11=11e-1;
tend=1;
u_init=0;
du_init=0;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Mono
M=diag([m_1, m_2, m_3, m_4, m_5, m_6, m_7, m_8, m_9, m_10, m_11]);
K=[k11+k21+k31+k41 -k11*l1-k41*l1+k21*l2+k31*l2 -k11*l3-k21*l3+k31*l4+k41*l4 -k11 0 -k21 0 -k31 0 -k41 0;
   0 l1*l1*k11+l2*l2*k21+l2*l2*k31+l1*l1*k41 l1*l3*k11-l3*l2*k21+l2*l4*k31-l1*l4*k41 l1*k11 0 -l2*k21 0 -l2*k31 0 l1*k41 0;
   0 0 l3*l3*k11+l3*l3*k21+l4*l4*k31+l4*l4*k41 l3*k11 0 l3*k21 0 -l4*k31 0 -l4*k41 0;
   0 0 0 k11+k12 -k12 0 0 0 0 0 0;
   0 0 0 0 k12 0 0 0 0 0 0;
   0 0 0 0 0 k21+k22 -k22 0 0 0 0;
   0 0 0 0 0 0 k22 0 0 0 0;
   0 0 0 0 0 0 0 k31+k32 -k32 0 0;
   0 0 0 0 0 0 0 0 k32 0 0;
   0 0 0 0 0 0 0 0 0 k41+k42 -k42;
   0 0 0 0 0 0 0 0 0 0 k42];
K=K+K'-diag(diag(K));
D = K *0;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Allocate memory
t=zeros(1000+1,1);
u_sol=zeros(1000+1,11);
u_n_p_1=zeros(11,1);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
h=1/(1000);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
u_n=[u_init; zeros(10,1)];
u_n_m_1=[u_init; zeros(10,1)]-h*[du_init; zeros(10,1)];
A=((1/(h*h))*M+(1/h)*D+K);
B=((2/(h*h))*M+(1/h)*D);
f_n_p_1=[1.1; zeros(10,1)];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Time loop
j=2;
tic
for i = h:h:tend
    u_n_p_1=A\(B*u_n-((1/(h*h))*M)*u_n_m_1+f_n_p_1);
   % Get solution
    t(j)=i;   
    u_sol(j,:)=u_n_p_1;   
    u_n_m_1=u_n;
    u_n    =u_n_p_1;
    j=j+1;
end
toc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Some plots
figure();
plot(t,u_sol(:,1)); grid on;
legend;

disp(u_sol(501,1))
disp(u_sol(1001,1))

