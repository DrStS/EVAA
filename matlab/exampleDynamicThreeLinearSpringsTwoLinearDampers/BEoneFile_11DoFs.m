clc;
clear;
close all;
format long e;
% Dynamic Backward Euler problem
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
k=10;
k11=1.1;k12=k;k21=1.2;k22=k;k31=1.3;k32=k;k41=1.4;k42=k;
l1=2;l2=1;l3=0.8;l4=1.25;
d_1=1/10;
d_2=1/2;
m_1=1e-1;
m_2=2e-1;
m_3=3e-1;
m_4=4e-1;
m_5=5e-1;
m_6=6e-1;
m_7=7e-1;
m_8=8e-1;
m_9=9e-1;
m_10=10e-1;
m_11=11e-1;
tend=1;
u_init=1;
du_init=0;
n=10    ; % refinement 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Mono
M=diag([m_1, m_2, m_3, m_4, m_5, m_6, m_7, m_8, m_9, m_10, m_11]);
K=[k11+k21+k31+k41 -k11*l1-k41*l1+k21*l2+k31*l2 -k11*l3-k21*l3+k31*l4+k41*l4 -k11 0 -k21 0 -k31 0 -k41 0;
   0 l1*l1*k11+l2*l2*k21+l2*l2*k31+l1*l1*k41 l1*l3*k11-l3*l2*k21+l2*l4*k31-l1*l4*k41 l1*k11 0 -l2*k21 0 -l2*k31 0 l1*k41 0;
   0 0 l3*l3*k11+l3*l3*k21+l4*l4*k31+l4*l4*k41 l3*k11 0 l3*k21 0 -l4*k31 0 -l4*k41 0;
   0 0 0 k11+k12 -k12 0 0 0 0 0 0;
   0 0 0 0 k12 0 0 0 0 0 0;
   0 0 0 0 0 k21+k22 -k22 0 0 0 0;
   0 0 0 0 0 0 k22 0 0 0 0;
   0 0 0 0 0 0 0 k31+k32 -k32 0 0;
   0 0 0 0 0 0 0 0 k32 0 0;
   0 0 0 0 0 0 0 0 0 k41+k42 -k42;
   0 0 0 0 0 0 0 0 0 0 k42];
K=K+K'-diag(diag(K));
D = K / 10;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Allocate memory
t=zeros(2^n+1,1);
u_sol=zeros(2^n+1,11);
u_n_p_1=zeros(11,1);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
h=1/(2^n);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
u_n=[u_init; zeros(10,1)];
u_n_m_1=[u_init; zeros(10,1)]-h*[du_init; zeros(10,1)];
A=((1/(h*h))*M+(1/h)*D+K);
B=((2/(h*h))*M+(1/h)*D);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Time loop
j=2;
tic
for i = h:h:tend
    u_n_p_1=A\(B*u_n-((1/(h*h))*M)*u_n_m_1);
   % Get solution
    t(j)=i;   
    u_sol(j,:)=u_n_p_1;
   
    u_n_m_1=u_n;
    u_n    =u_n_p_1;
    j=j+1;
end
toc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Some plots
figure();
plot(t,u_sol); grid on;
legend;

disp(u_sol(end,:)')

%% Initial matrices to compare
M_blaze = [ 1.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 2.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 3.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 4.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 5.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 6.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 7.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 8.000000e-01 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 9.000000e-01 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.100000e+00 ];

D_blaze = [5.000000e-01 -2.500000e-01 1.535000e-01 -1.100000e-01 0.000000e+00 -1.200000e-01 0.000000e+00 -1.300000e-01 0.000000e+00 -1.400000e-01 0.000000e+00 
 -2.500000e-01 1.250000e+00 -1.075000e-01 2.200000e-01 0.000000e+00 -1.200000e-01 0.000000e+00 -1.300000e-01 0.000000e+00 2.800000e-01 0.000000e+00 
 1.535000e-01 -1.075000e-01 5.690750e-01 8.800000e-02 0.000000e+00 9.600000e-02 0.000000e+00 -1.625000e-01 0.000000e+00 -1.750000e-01 0.000000e+00 
 -1.100000e-01 2.200000e-01 8.800000e-02 1.110000e+00 -1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.200000e-01 -1.200000e-01 9.600000e-02 0.000000e+00 0.000000e+00 1.120000e+00 -1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.300000e-01 -1.300000e-01 -1.625000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.130000e+00 -1.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 
 -1.400000e-01 2.800000e-01 -1.750000e-01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.140000e+00 -1.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+00 1.000000e+00 ];

K_blaze = [5.000000e+00 -2.500000e+00 1.535000e+00 -1.100000e+00 0.000000e+00 -1.200000e+00 0.000000e+00 -1.300000e+00 0.000000e+00 -1.400000e+00 0.000000e+00 
 -2.500000e+00 1.250000e+01 -1.075000e+00 2.200000e+00 0.000000e+00 -1.200000e+00 0.000000e+00 -1.300000e+00 0.000000e+00 2.800000e+00 0.000000e+00 
 1.535000e+00 -1.075000e+00 5.690750e+00 8.800000e-01 0.000000e+00 9.600000e-01 0.000000e+00 -1.625000e+00 0.000000e+00 -1.750000e+00 0.000000e+00 
 -1.100000e+00 2.200000e+00 8.800000e-01 1.110000e+01 -1.000000e+01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+01 1.000000e+01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.200000e+00 -1.200000e+00 9.600000e-01 0.000000e+00 0.000000e+00 1.120000e+01 -1.000000e+01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+01 1.000000e+01 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.300000e+00 -1.300000e+00 -1.625000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.130000e+01 -1.000000e+01 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+01 1.000000e+01 0.000000e+00 0.000000e+00 
 -1.400000e+00 2.800000e+00 -1.750000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.140000e+01 -1.000000e+01 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.000000e+01 1.000000e+01];

%% h = 1 / 2^10

A_blaze = [ 1.053746e+05 -2.585000e+02 1.587190e+02 -1.137400e+02 0.000000e+00 -1.240800e+02 0.000000e+00 -1.344200e+02 0.000000e+00 -1.447600e+02 0.000000e+00 
 -2.585000e+02 2.110077e+05 -1.111550e+02 2.274800e+02 0.000000e+00 -1.240800e+02 0.000000e+00 -1.344200e+02 0.000000e+00 2.895200e+02 0.000000e+00 
 1.587190e+02 -1.111550e+02 3.151612e+05 9.099200e+01 0.000000e+00 9.926400e+01 0.000000e+00 -1.680250e+02 0.000000e+00 -1.809500e+02 0.000000e+00 
 -1.137400e+02 2.274800e+02 9.099200e+01 4.205781e+05 -1.034000e+03 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 5.253220e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.240800e+02 -1.240800e+02 9.926400e+01 0.000000e+00 0.000000e+00 6.303037e+05 -1.034000e+03 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 7.350372e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.344200e+02 -1.344200e+02 -1.680250e+02 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 8.400292e+05 -1.034000e+03 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 9.447524e+05 0.000000e+00 0.000000e+00 
 -1.447600e+02 2.895200e+02 -1.809500e+02 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.049755e+06 -1.034000e+03 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 1.154468e+06 ];

B_blaze = [  2.102272e+05 -2.560000e+02 1.571840e+02 -1.126400e+02 0.000000e+00 -1.228800e+02 0.000000e+00 -1.331200e+02 0.000000e+00 -1.433600e+02 0.000000e+00 
 -2.560000e+02 4.207104e+05 -1.100800e+02 2.252800e+02 0.000000e+00 -1.228800e+02 0.000000e+00 -1.331200e+02 0.000000e+00 2.867200e+02 0.000000e+00 
 1.571840e+02 -1.100800e+02 6.297283e+05 9.011200e+01 0.000000e+00 9.830400e+01 0.000000e+00 -1.664000e+02 0.000000e+00 -1.792000e+02 0.000000e+00 
 -1.126400e+02 2.252800e+02 9.011200e+01 8.399974e+05 -1.024000e+03 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 -1.024000e+03 1.049600e+06 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.228800e+02 -1.228800e+02 9.830400e+01 0.000000e+00 0.000000e+00 1.259438e+06 -1.024000e+03 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.024000e+03 1.469030e+06 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.331200e+02 -1.331200e+02 -1.664000e+02 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.678879e+06 -1.024000e+03 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.024000e+03 1.888461e+06 0.000000e+00 0.000000e+00 
 -1.433600e+02 2.867200e+02 -1.792000e+02 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 2.098319e+06 -1.024000e+03 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.024000e+03 2.307891e+06   ];

L_blaze = [ 1.053746e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -2.585000e+02 2.110071e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 1.587190e+02 -1.107656e+02 3.151609e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.137400e+02 2.272010e+02 9.128259e+01 4.205777e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 5.253195e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.240800e+02 -1.243844e+02 9.938560e+01 -2.878585e-02 -7.077067e-05 6.303034e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 7.350355e+05 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 -1.344200e+02 -1.347498e+02 -1.678933e+02 4.862827e-02 1.195537e-04 -1.847687e-01 -3.031092e-04 8.400289e+05 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 9.447511e+05 0.000000e+00 0.000000e+00 
 -1.447600e+02 2.891649e+02 -1.805802e+02 -4.153063e-01 -1.021040e-03 5.694570e-02 9.341826e-05 -9.619902e-02 -1.184123e-04 1.049754e+06 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 -1.034000e+03 1.154467e+06 ];

U_blaze = [ 1.000000e+00 -2.453153e-03 1.506236e-03 -1.079387e-03 0.000000e+00 -1.177513e-03 0.000000e+00 -1.275639e-03 0.000000e+00 -1.373766e-03 0.000000e+00 
 0.000000e+00 1.000000e+00 -5.249381e-04 1.076746e-03 0.000000e+00 -5.894797e-04 0.000000e+00 -6.386030e-04 0.000000e+00 1.370404e-03 0.000000e+00 
 0.000000e+00 0.000000e+00 1.000000e+00 2.896380e-04 0.000000e+00 3.153487e-04 0.000000e+00 -5.327223e-04 0.000000e+00 -5.729776e-04 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -2.458523e-03 -6.844358e-08 0.000000e+00 1.156226e-07 0.000000e+00 -9.874662e-07 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -1.347193e-10 0.000000e+00 2.275829e-10 0.000000e+00 -1.943655e-09 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -1.640480e-03 -2.931424e-07 0.000000e+00 9.034648e-08 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -4.123736e-10 0.000000e+00 1.270935e-10 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -1.230910e-03 -1.145187e-07 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -1.253371e-10 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 -9.849926e-04 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 ];

P_blaze = [ 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 0.000000e+00 
 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 0.000000e+00 1.000000e+00 ];


norm(A_blaze-A)
norm(B_blaze-B)
norm(A_blaze-A)-norm(B_blaze-B)